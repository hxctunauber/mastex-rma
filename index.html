<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASTEX RMA System (v122.19 Final)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-deep: #050505; --border-dim: #333; --text-main: #e5e5e5; }
        body { background-color: var(--bg-deep); color: var(--text-main); font-family: 'Inter', sans-serif; background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px); background-size: 40px 40px; min-height: 100vh; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .font-mono-tech { font-family: 'JetBrains Mono', monospace; }
        .tech-card { background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(12px); border: 1px solid #27272a; transition: all 0.3s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .tech-card:hover { border-color: #52525b; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        .tech-input { background-color: #09090b; border: 1px solid #3f3f46; color: #fff; transition: all 0.2s; font-size: 1rem; padding: 0.6rem; width: 100%; border-radius: 0.25rem; }
        .tech-input:focus { outline: none; border-color: #fff; box-shadow: 0 0 0 2px rgba(255,255,255,0.1); }
        .locked-section { opacity: 0.4; pointer-events: none; filter: grayscale(100%); border-style: dashed; }
        .cs-zone-bg { background: linear-gradient(180deg, rgba(59, 130, 246, 0.05) 0%, rgba(0,0,0,0) 100%); border-top: 1px solid #3b82f6; }
        .sales-zone-bg { background: linear-gradient(180deg, rgba(245, 158, 11, 0.05) 0%, rgba(0,0,0,0) 100%); border-top: 1px solid #f59e0b; }
        .tech-zone-bg { background: linear-gradient(180deg, rgba(113, 113, 122, 0.05) 0%, rgba(0,0,0,0) 100%); border-top: 1px solid #71717a; }
        .rma-row { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .highlight-section { animation: highlightPulse 1.5s ease-out infinite; border: 2px solid #2dd4bf !important; }
        @keyframes highlightPulse { 0% { box-shadow: 0 0 0 0 rgba(45, 212, 191, 0.7); border-color: #2dd4bf; } 70% { box-shadow: 0 0 0 15px rgba(45, 212, 191, 0); border-color: #2dd4bf; } 100% { box-shadow: 0 0 0 0 rgba(45, 212, 191, 0); border-color: #333; } }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #2dd4bf; font-family: monospace; z-index: 9999; }
        #error-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); color: #ff5555; z-index: 10000; padding: 40px; font-family: monospace; overflow: auto; }
        @media print { @page { margin: 0; size: A4 portrait; } body { background: white !important; color: black !important; background-image: none !important; } .print-hidden { display: none !important; } .tech-card, input, select, textarea { border: 1px solid #000 !important; background: white !important; color: black !important; box-shadow: none !important; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="loading-screen"><div>SYSTEM INITIALIZING... v122.19</div></div>
    <div id="error-overlay"></div>
    
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('loading-screen').style.display = 'none';
            const overlay = document.getElementById('error-overlay');
            overlay.style.display = 'block';
            overlay.innerHTML = `<h2>System Error</h2><p>${msg}</p><p>${url}:${line}:${col}</p><button onclick="localStorage.clear();location.reload()" style="margin-top:20px;padding:10px;background:#900;color:#fff;border:none;">HARD RESET</button>`;
        };
    </script>

    <script type="text/babel">
        // --- 1. CONSTANTS & CONFIG (No exports) ---
        const { useState, useEffect, useRef, Fragment } = React;

        const PRESET_FIREBASE_CONFIG = {
          apiKey: "AIzaSyDm1zPY6DHErybLZ-MfJOsLEywShNBcB_c",
          authDomain: "mastex-205a8.firebaseapp.com",
          projectId: "mastex-205a8",
          storageBucket: "mastex-205a8.firebasestorage.app",
          messagingSenderId: "669513814730",
          appId: "1:669513814730:web:842f3be1c0557069151a33",
          measurementId: "G-4FKPEYMCRP"
        };

        const INITIAL_BRANDS = {
            Keychron: { models: ['B36','B6 Pro','K10 Max','K4 QMK','K3 QMK','K2 HE','K4 HE','K8 HE','K10 HE','K1 Max','K2 Max','K3 Max','K5 Max','K8 Max','K10 Max ZMK','K2 QMK','K5 QMK','K8 QMK','K10 QMK','Q1 Max','Q3 Max','Q6 Max','Q10 Max','Q12 Max','Q0 Max','Q1','Q2','Q3','V1 Max','V3 Max','V5 Max','V6 Max','V10 Max','B1 Pro','B2 Pro'], commonIssues: ['藍牙配對失敗','2.4G 接收器無反應','喚醒延遲','旋鈕失效','電池膨脹','按鍵連點'] },
            NuPhy: { models: ['Air75 V3','Kick75','Air75 HE','Halo96 V2','Gem80','Halo75 V2','Air75 V2'], commonIssues: ['2.4G 連線不穩','腳架斷裂','RGB 死燈','矮軸觸發異常'] },
            Yunzii: { models: ['AL66','AL71','AL75','B75','C68','X75'], commonIssues: ['驅動程式無法偵測','燈光異常'] }
        };
        const INITIAL_ACCESSORIES = ['原廠傳輸線','拔軸器','拔鍵器','2.4G 接收器','轉接頭 (A to C)','防塵蓋'];
        const INITIAL_COURIERS = ['新竹物流 (HCT)','7-11 店到店','全家','順豐速運 (SF)'];
        const INITIAL_SOURCES = ['蝦皮 (Keychron)','蝦皮 (NuPhy)','官網','經銷商','MOMO','PChome'];
        const INITIAL_DEALERS = ['PC Party','改裝軍團','硬派精璽','原價屋','良興','一統電競','宇星'];
        const CONDITIONS = ['全新','近全新','良好','有使用痕跡','輕微瑕疵','明顯磨損'];
        
        const INITIAL_STATE = {
            id: '', rmaNumber: '', refNumber: '', customerType: 'C', dealerName: '', creationDate: '',
            isReceived: false, receivedDate: '', purchaseDate: '', source: '', csAction: null,
            tmsImported: false, endUserName: '', endUserPhone: '', endUserEmail: '',
            recipientName: '', recipientPhone: '', recipientAddress: '', recipientBrand: '', recipientModel: '',
            returnDate: '', customerName: '', customerContact: '', brand: 'Keychron', model: '',
            serialNumber: '', warrantyStatus: '保固內', productCondition: '有使用痕跡', accessories: [],
            customerDescription: '', reportedIssue: '',
            diagnosis: { physicalCheck: 'pending', connectionCheck: 'pending', batteryCheck: 'pending', switchCheck: 'pending' },
            repairAction: '', partsReplaced: '', technicianNotes: '', status: '待收件',
            resolution: '', defectiveLoc: '', returnTarget: '', trackingNumber: '', courier: '新竹物流 (HCT)',
            isBorrowed: false, displayLog: []
        };

        const STATUS_STYLES = {
            '待收件': 'text-gray-400 border-gray-600', 'Pending': 'text-gray-400 border-gray-600',
            '檢測中': 'text-white border-white shadow-[0_0_8px_rgba(255,255,255,0.5)]', 'Checking': 'text-white border-white shadow-[0_0_8px_rgba(255,255,255,0.5)]',
            '待料中': 'text-yellow-400 border-yellow-600 border-dashed', 'Waiting Parts': 'text-yellow-400 border-yellow-600 border-dashed',
            '新品待寄出': 'text-yellow-400 border-yellow-500 font-bold', 'Pending Ship': 'text-yellow-400 border-yellow-500 font-bold',
            '新品已寄出': 'text-green-400 border-green-500 font-bold', 'Shipped': 'text-green-400 border-green-500 font-bold',
            '完修待寄回': 'text-blue-400 border-blue-500 font-bold', 'Repaired': 'text-blue-400 border-blue-500 font-bold',
            '待入庫': 'text-teal-400 border-teal-500 font-bold',
            '已寄回': 'text-gray-300 border-double border-white', 'Returned': 'text-gray-300 border-double border-white',
            '修復入庫': 'text-teal-400 border-teal-500', 'Restocked': 'text-teal-400 border-teal-500',
            '已寄原廠': 'text-gray-400 border-dotted border-gray-500', 'Shipped to Brand': 'text-gray-400 border-dotted border-gray-500',
            '待寄原廠': 'text-red-500 border-red-800', 'To Brand': 'text-red-500 border-red-800'
        };

        const DEFECTIVE_LOC_LABELS = { 'warehouse': '留倉 INVENTORY', 'waiting_parts': '待料中 PARTS', 'brand_rma': '待寄原廠 TO BRAND', 'shipped_brand': '已寄原廠 SHIPPED', 'display': '展示機 DISPLAY' };
        const DEFECTIVE_LOC_STYLES = { 'warehouse': 'text-teal-400 border-teal-500 bg-teal-900/10', 'waiting_parts': 'text-yellow-400 border-yellow-500 border-dashed bg-yellow-900/10', 'brand_rma': 'text-red-400 border-red-500 bg-red-900/10', 'shipped_brand': 'text-gray-400 border-gray-500 border-dotted', 'display': 'text-blue-400 border-blue-500' };
        const CHECKLIST_LABELS = { physicalCheck: '外觀檢查 Physical', connectionCheck: '連線測試 Connection', batteryCheck: '電池狀況 Battery', switchCheck: '軸體觸發 Switch' };
        const CHECKLIST_OPTIONS = { pending: '待測 Pending', pass: '通過 PASS', fail: '失敗 FAIL', na: '不適用 N/A' };
        
        const DEFAULT_THEME_IMAGES = {
            CS: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072',
            URGENT: 'https://images.unsplash.com/photo-1597424214791-722a57ed6781?q=80&w=2070',
            PENDING: 'https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=2070',
            SHIPPING: 'https://images.unsplash.com/photo-1565514020176-db7923700b8c?q=80&w=2000',
            HISTORY: 'https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?q=80&w=2070',
            INVENTORY: 'https://images.unsplash.com/photo-1558494949-ef526bca4899?q=80&w=2000'
        };

        // --- 2. COMPONENTS (Converted to Standard JS) ---
        
        const Icon = ({ name, size = 20, className = "" }) => {
            // Icons mapping directly inside function to avoid scope issues
            const icons = {
                Plus: <path d="M5 12h14M12 5v14" />,
                Search: <React.Fragment><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></React.Fragment>,
                User: <React.Fragment><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></React.Fragment>,
                Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2zM12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" />,
                Box: <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16zM3.27 6.96 12 12.01l8.73-5.05M12 22.08V12" />,
                Cpu: <React.Fragment><rect x="4" y="4" width="16" height="16" rx="2" /><rect x="9" y="9" width="6" height="6" /><path d="M9 1v3M15 1v3M9 20v3M15 20v3M20 9h3M20 14h3M1 9h3M1 14h3" /></React.Fragment>,
                Printer: <React.Fragment><path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><path d="M6 14h12v8H6z" /></React.Fragment>,
                Save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8" />,
                AlertTriangle: <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />,
                Truck: <React.Fragment><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11" /><path d="M14 9h4l4 4.5V13.5" /><path d="M17 17H7" /><circle cx="17" cy="17" r="2" /><circle cx="7" cy="17" r="2" /></React.Fragment>,
                Activity: <path d="M22 12h-4l-3 9L9 3l-3 9H2" />,
                Database: <React.Fragment><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></React.Fragment>,
                Briefcase: <React.Fragment><rect width="20" height="14" x="2" y="7" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></React.Fragment>,
                Package: <React.Fragment><path d="m16.5 9.4-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><polyline points="3.27 6.96 12 12.01 20.73 6.96" /><line x1="12" x2="12" y1="22.08" y2="12" /></React.Fragment>,
                Clock: <React.Fragment><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></React.Fragment>,
                Edit: <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />,
                Image: <React.Fragment><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></React.Fragment>,
                RefreshCcw: <React.Fragment><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></React.Fragment>,
                Cloud: <React.Fragment><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19" /><path d="M19 13.5c2.485 0 4.5 2.015 4.5 4.5s-2.015 4.5-4.5 4.5H6c-2.761 0-5-2.239-5-5s2.239-5 5-5c.174 0 .345.01.513.029C7.02 9.692 9.277 8 12 8c3.005 0 5.478 2.074 6.18 4.91" /></React.Fragment>,
                CloudOff: <React.Fragment><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 7h1.8a5 5 0 0 1 8.8 4" /><line x1="1" y1="1" x2="23" y2="23" /></React.Fragment>,
                Wifi: <path d="M5 12.55a11 11 0 0 1 14.08 0M1.42 9a16 16 0 0 1 21.16 0M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01" />,
                WifiOff: <React.Fragment><line x1="1" y1="1" x2="23" y2="23" /><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55" /><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39" /><path d="M10.71 5.05A16 16 0 0 1 22.58 9" /><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" y1="20" x2="12.01" y2="20" /></React.Fragment>,
                CheckCircle: <React.Fragment><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><path d="m9 11 3 3L22 4" /></React.Fragment>,
                Trash2: <React.Fragment><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></React.Fragment>,
                X: <path d="M18 6 6 18M6 6l12 12" />,
                ArrowLeft: <path d="m12 19-7-7 7-7M19 12H5" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.75" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const Logo = () => (
            <div className="w-10 h-10 bg-white rounded flex items-center justify-center shrink-0 shadow-lg overflow-hidden">
                <svg viewBox="0 0 24 24" fill="none" stroke="black" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                </svg>
            </div>
        );

        const DualLabel = ({ zh, en, required }) => (
            <label className="block mb-2">
                <div className="flex items-end gap-2">
                    <span className="text-base font-bold text-gray-200 tracking-wide">{zh}</span>
                    <span className="text-xs font-mono-tech text-gray-500 uppercase tracking-wider">{en}</span>
                    {required && <span className="text-red-500 text-base">*</span>}
                </div>
            </label>
        );

        const DualText = ({ zh, en, className = "" }) => (
            <span className={className}>
                <span className="font-bold text-lg">{zh}</span>
                <span className="ml-2 text-xs font-mono-tech text-gray-500 uppercase tracking-wider font-normal">{en}</span>
            </span>
        );

        const SectionHeader = ({ zh, en, icon, color = "text-white" }) => (
            <div className="flex items-center gap-3 mb-6 border-b border-white/10 pb-3">
                <span className={color}><Icon name={icon} size={24} /></span>
                <h3 className={`text-lg font-bold ${color}`}><DualText zh={zh} en={en} /></h3>
            </div>
        );

        const SwipeableRow = ({ children, onDelete, onClick, className, isDeleting, onConfirm, onCancel }) => {
            const [startX, setStartX] = useState(null);
            const [offsetX, setOffsetX] = useState(0);
            const handleTouchStart = (e) => setStartX(e.targetTouches[0].clientX);
            const handleTouchMove = (e) => {
                if (startX === null) return;
                const diff = e.targetTouches[0].clientX - startX;
                if (diff < 0) {
                    setOffsetX(diff);
                    if (Math.abs(diff) > 10 && e.cancelable) e.preventDefault();
                }
            };
            const handleTouchEnd = () => {
                if (offsetX < -80) onDelete();
                setOffsetX(0);
                setStartX(null);
            };
            const currentOffset = isDeleting ? -160 : offsetX;
            const style = {
                transform: `translateX(${currentOffset}px)`,
                transition: startX ? 'none' : 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                backgroundColor: Math.abs(currentOffset) > 20 || isDeleting ? '#18181b' : 'transparent'
            };
            return (
                <tr className={`${className} relative overflow-hidden`} style={style} onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd} onClick={(e) => { if (Math.abs(offsetX) > 5) return; onClick(e); }}>
                    {children}
                    <div className="absolute top-0 bottom-0 flex items-center justify-center gap-2 z-30 h-full border-l border-zinc-700 bg-zinc-900" style={{ right: '-160px', width: '160px', visibility: (isDeleting || offsetX < 0) ? 'visible' : 'hidden' }}>
                        <button onClick={(e) => { e.stopPropagation(); onConfirm() }} className="bg-red-600 hover:bg-red-500 text-white px-4 py-1.5 rounded text-xs font-bold transition-colors">確定</button>
                        <button onClick={(e) => { e.stopPropagation(); onCancel() }} className="bg-zinc-700 hover:bg-zinc-600 text-gray-200 px-4 py-1.5 rounded text-xs font-bold transition-colors">取消</button>
                    </div>
                </tr>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title = "未儲存變更 UNSAVED CHANGES", message = "您有尚未儲存的變更，離開將導致資料遺失。\n確定要離開嗎？", confirmText = "放棄變更 LEAVE", cancelText = "繼續編輯 STAY", isAlert = false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
                    <div className={`bg-zinc-900 border ${isAlert ? 'border-zinc-600' : 'border-red-500/50'} rounded-xl w-full max-w-md p-6 shadow-2xl relative`}>
                        <div className="flex flex-col items-center text-center gap-4 mb-6">
                            <div className={`w-16 h-16 rounded-full flex items-center justify-center border ${isAlert ? 'bg-zinc-800 text-white border-zinc-600' : 'bg-red-900/20 text-red-500 border-red-900'}`}>
                                <Icon name="AlertTriangle" size={32} />
                            </div>
                            <h3 className="text-xl font-bold text-white">{title}</h3>
                            <p className="text-gray-400 whitespace-pre-line leading-relaxed">{message}</p>
                        </div>
                        <div className={`grid ${isAlert ? 'grid-cols-1' : 'grid-cols-2'} gap-4`}>
                            {!isAlert && (
                                <button onClick={onClose} className="py-3 px-4 bg-zinc-800 hover:bg-zinc-700 text-white rounded font-bold transition-colors border border-zinc-700">
                                    {cancelText}
                                </button>
                            )}
                            <button onClick={() => { onConfirm(); onClose(); }} className={`py-3 px-4 text-white rounded font-bold transition-colors shadow-lg ${isAlert ? 'bg-white text-black hover:bg-gray-200' : 'bg-red-600 hover:bg-red-500 shadow-red-900/20'}`}>
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ConfigModal = ({ isOpen, onClose, currentBrands, currentDealers, currentAccessories, currentTheme, onSave, onSaveFirebase }) => {
            const [activeTab, setActiveTab] = useState('cloud');
            const [brands, setBrands] = useState(currentBrands);
            const [dealers, setDealers] = useState(currentDealers);
            const [accessories, setAccessories] = useState(currentAccessories);
            const [theme, setTheme] = useState(currentTheme || DEFAULT_THEME_IMAGES);
            const [fbConfig, setFbConfig] = useState({ apiKey: '', authDomain: '', projectId: '', storageBucket: '', messagingSenderId: '', appId: '' });
            const [selectedBrand, setSelectedBrand] = useState('');
            const [newBrandName, setNewBrandName] = useState('');
            const [newModelName, setNewModelName] = useState('');
            const [newDealerName, setNewDealerName] = useState('');
            const [newAccessoryName, setNewAccessoryName] = useState('');
            
            const THEME_LABELS = {
                CS: '客服中心', URGENT: '急件待修', PENDING: '一般待修',
                SHIPPING: '產品待寄', HISTORY: '已出貨', INVENTORY: '舊品庫存'
            };

            useEffect(() => {
                if (isOpen) {
                    setBrands(currentBrands || INITIAL_BRANDS);
                    setDealers(currentDealers || INITIAL_DEALERS);
                    setAccessories(currentAccessories || INITIAL_ACCESSORIES);
                    setTheme(currentTheme || DEFAULT_THEME_IMAGES);
                    const keys = Object.keys(currentBrands || INITIAL_BRANDS);
                    if (keys.length > 0 && !selectedBrand) setSelectedBrand(keys[0]);
                    
                    const savedFbStr = localStorage.getItem('mastex_firebase_config');
                    if (savedFbStr) {
                        try { setFbConfig(JSON.parse(savedFbStr)); } catch (e) { }
                    } else if (PRESET_FIREBASE_CONFIG) {
                        setFbConfig(PRESET_FIREBASE_CONFIG);
                    }
                }
            }, [isOpen, currentBrands, currentDealers, currentAccessories, currentTheme]);

            if (!isOpen) return null;

            const handleSaveAll = () => { onSave(brands, dealers, accessories, theme); if (fbConfig.apiKey) onSaveFirebase(fbConfig); else if (!fbConfig.apiKey) onSaveFirebase(null); };
            const handleAddBrand = () => { if (!newBrandName.trim() || brands[newBrandName]) return; setBrands(p => ({ ...p, [newBrandName]: { models: [], commonIssues: [] } })); setSelectedBrand(newBrandName); setNewBrandName(''); };
            const handleDeleteBrand = (b) => { if (!confirm(`Delete ${b}?`)) return; setBrands(p => { const n = { ...p }; delete n[b]; return n; }); if (selectedBrand === b) setSelectedBrand(''); };
            const handleAddModel = () => { if (!selectedBrand || !newModelName.trim() || brands[selectedBrand].models.includes(newModelName)) return; setBrands(p => ({ ...p, [selectedBrand]: { ...p[selectedBrand], models: [...p[selectedBrand].models, newModelName] } })); setNewModelName(''); };
            const handleDeleteModel = (m) => { if (!selectedBrand) return; setBrands(p => ({ ...p, [selectedBrand]: { ...p[selectedBrand], models: p[selectedBrand].models.filter(x => x !== m) } })); };
            const handleAddDealer = () => { if (!newDealerName.trim() || dealers.includes(newDealerName)) return; setDealers(p => [...p, newDealerName]); setNewDealerName(''); };
            const handleDeleteDealer = (d) => { if (!confirm(`Delete ${d}?`)) return; setDealers(p => p.filter(x => x !== d)); };
            const handleAddAccessory = () => { if (!newAccessoryName.trim() || accessories.includes(newAccessoryName)) return; setAccessories(p => [...p, newAccessoryName]); setNewAccessoryName(''); };
            const handleDeleteAccessory = (a) => { if (!confirm(`Delete ${a}?`)) return; setAccessories(p => p.filter(x => x !== a)); };

            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="bg-zinc-900 border border-zinc-700 rounded-xl w-full max-w-4xl h-[85vh] flex flex-col shadow-2xl relative overflow-hidden">
                        <div className="p-6 border-b border-zinc-700 flex justify-between items-center bg-black/50"><h3 className="text-xl font-bold text-white flex items-center gap-3"><Icon name="Settings" size={24} /> 系統配置 SYSTEM CONFIGURATION</h3><button onClick={onClose} className="text-gray-500 hover:text-white"><Icon name="X" size={24} /></button></div>
                        <div className="flex border-b border-zinc-700 bg-black/30 overflow-x-auto">
                            <button onClick={() => setActiveTab('cloud')} className={`flex-1 min-w-[120px] py-4 font-bold text-sm ${activeTab === 'cloud' ? 'text-green-400 border-b-2 border-green-500 bg-green-900/20' : 'text-gray-500'}`}>☁️ 雲端連線</button>
                            <button onClick={() => setActiveTab('theme')} className={`flex-1 min-w-[100px] py-4 font-bold text-sm ${activeTab === 'theme' ? 'text-white border-b-2 border-orange-500 bg-zinc-800/50' : 'text-gray-500'}`}>圖片主題</button>
                            <button onClick={() => setActiveTab('brands')} className={`flex-1 min-w-[100px] py-4 font-bold text-sm ${activeTab === 'brands' ? 'text-white border-b-2 border-blue-500 bg-zinc-800/50' : 'text-gray-500'}`}>產品配置</button>
                            <button onClick={() => setActiveTab('accessories')} className={`flex-1 min-w-[100px] py-4 font-bold text-sm ${activeTab === 'accessories' ? 'text-white border-b-2 border-teal-500 bg-zinc-800/50' : 'text-gray-500'}`}>配件管理</button>
                            <button onClick={() => setActiveTab('dealers')} className={`flex-1 min-w-[100px] py-4 font-bold text-sm ${activeTab === 'dealers' ? 'text-white border-b-2 border-purple-500 bg-zinc-800/50' : 'text-gray-500'}`}>經銷商</button>
                        </div>
                        <div className="flex-1 flex overflow-hidden">
                            {activeTab === 'brands' && <div className="flex flex-1 w-full h-full"><div className="w-1/3 border-r border-zinc-700 flex flex-col bg-black/20"><div className="p-4 bg-zinc-800/50 border-b border-zinc-700"><div className="flex gap-2"><input className="flex-1 bg-black border border-zinc-600 rounded px-2 py-1 text-white text-sm" placeholder="New Brand..." value={newBrandName} onChange={e => setNewBrandName(e.target.value)} /><button onClick={handleAddBrand} className="bg-blue-600 text-white px-3 py-1 rounded"><Icon name="Plus" size={16} /></button></div></div><div className="flex-1 overflow-y-auto p-2 space-y-1">{Object.keys(brands).map(b => (<div key={b} onClick={() => setSelectedBrand(b)} className={`flex justify-between items-center px-4 py-3 rounded cursor-pointer ${selectedBrand === b ? 'bg-zinc-700 text-white font-bold border-l-4 border-blue-500' : 'text-gray-400 hover:bg-zinc-800'}`}><span>{b}</span><div onClick={(e) => { e.stopPropagation(); handleDeleteBrand(b); }} className="p-2 hover:text-red-500"><Icon name="Trash2" size={16} /></div></div>))}</div></div><div className="flex-1 flex flex-col bg-zinc-900 p-4">{selectedBrand ? (<React.Fragment><div className="flex gap-2 mb-4"><input className="flex-1 bg-black border border-zinc-600 rounded px-3 py-2 text-white" placeholder="Add Model..." value={newModelName} onChange={e => setNewModelName(e.target.value)} /><button onClick={handleAddModel} className="bg-green-600 text-white px-4 py-2 rounded font-bold">ADD</button></div><div className="grid grid-cols-2 md:grid-cols-3 gap-3 overflow-y-auto content-start">{brands[selectedBrand].models.map(m => (<div key={m} className="bg-black border border-zinc-700 rounded px-3 py-2 flex justify-between items-center group"><span className="text-gray-300 text-sm">{m}</span><button onClick={() => handleDeleteModel(m)} className="text-zinc-600 hover:text-red-500 opacity-0 group-hover:opacity-100"><Icon name="X" size={14} /></button></div>))}</div></React.Fragment>) : <p className="text-center text-gray-500 mt-10">Select a brand</p>}</div></div>}
                            {activeTab === 'dealers' && <div className="w-full flex flex-col bg-zinc-900 p-6"><div className="flex gap-2 mb-6 max-w-xl mx-auto w-full"><input className="flex-1 bg-black border border-zinc-600 rounded px-4 py-3 text-white" placeholder="New Dealer Name..." value={newDealerName} onChange={e => setNewDealerName(e.target.value)} /><button onClick={handleAddDealer} className="bg-purple-600 hover:bg-purple-500 text-white px-6 py-2 rounded font-bold">ADD DEALER</button></div><div className="flex-1 overflow-y-auto max-w-4xl mx-auto w-full"><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{dealers.map(d => (<div key={d} className="bg-black border border-zinc-700 rounded p-4 flex justify-between items-center group hover:border-zinc-500 transition-colors"><span className="text-gray-200 font-bold">{d}</span><button onClick={() => handleDeleteDealer(d)} className="text-zinc-600 hover:text-red-500 p-2"><Icon name="Trash2" size={18} /></button></div>))}</div></div></div>}
                            {activeTab === 'accessories' && <div className="w-full flex flex-col bg-zinc-900 p-6"><div className="flex gap-2 mb-6 max-w-xl mx-auto w-full"><input className="flex-1 bg-black border border-zinc-600 rounded px-4 py-3 text-white" placeholder="New Accessory..." value={newAccessoryName} onChange={e => setNewAccessoryName(e.target.value)} /><button onClick={handleAddAccessory} className="bg-teal-600 hover:bg-teal-500 text-white px-6 py-2 rounded font-bold">ADD ACCESSORY</button></div><div className="flex-1 overflow-y-auto max-w-4xl mx-auto w-full"><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{accessories.map(a => (<div key={a} className="bg-black border border-zinc-700 rounded p-4 flex justify-between items-center group hover:border-zinc-500 transition-colors"><span className="text-gray-200 font-bold">{a}</span><button onClick={() => handleDeleteAccessory(a)} className="text-zinc-600 hover:text-red-500 p-2"><Icon name="Trash2" size={18} /></button></div>))}</div></div></div>}
                            {activeTab === 'theme' && <div className="w-full flex flex-col bg-zinc-900 p-8 overflow-y-auto"><div className="max-w-3xl mx-auto w-full"><div className="mb-6 flex justify-between items-center"><div><h4 className="text-white font-bold text-lg mb-1">自訂儀表板背景 CUSTOM DASHBOARD THEME</h4><p className="text-gray-400 text-xs">輸入圖片網址 (URL) 即可更換背景。支援 Unsplash, Imgur 等連結。</p></div><button onClick={() => setTheme(DEFAULT_THEME_IMAGES)} className="flex items-center gap-2 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 rounded text-xs text-gray-300"><Icon name="RefreshCcw" size={14} /> 恢復預設 RESET</button></div><div className="grid grid-cols-1 md:grid-cols-2 gap-6">{Object.keys(DEFAULT_THEME_IMAGES).map(key => (<div key={key} className="bg-black border border-zinc-800 p-4 rounded-lg flex flex-col gap-3"><div className="flex justify-between items-center"><label className="text-xs font-bold text-gray-400 block">{THEME_LABELS[key]}</label></div><div className="flex gap-3"><div className="w-20 h-20 bg-zinc-900 rounded border border-zinc-700 overflow-hidden flex-shrink-0"><img src={theme[key]} alt={key} className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} onLoad={(e) => e.target.style.display = 'block'} /></div><textarea className="flex-1 bg-zinc-900 border border-zinc-700 rounded p-2 text-xs text-gray-300 break-all resize-none focus:border-blue-500 outline-none" rows={3} value={theme[key]} onChange={e => setTheme(prev => { return { ...prev, [key]: e.target.value }; })} placeholder="https://..." /></div></div>))}</div></div></div>}
                            {activeTab === 'cloud' && (
                                <div className="w-full flex flex-col bg-zinc-900 p-8 overflow-y-auto">
                                    <div className="max-w-2xl mx-auto w-full">
                                        <div className="mb-6 p-4 bg-green-900/10 border border-green-500/30 rounded-lg">
                                            <h4 className="text-green-400 font-bold mb-2 flex items-center gap-2"><Icon name="Cloud" size={20} /> Google Firebase Integration</h4>
                                            <p className="text-gray-400 text-sm mb-2">啟用此功能後，資料將儲存於 Google Cloud，實現多人即時協作。</p>
                                            {!localStorage.getItem('mastex_firebase_config') && fbConfig.apiKey && (<div className="bg-blue-900/30 border border-blue-500 p-3 rounded mb-4 text-xs text-blue-200 mt-4"><strong>已自動載入預設設定 (Preset Loaded)</strong><br/>系統檢測到您尚未設定，已自動填入共用資料庫連線資訊。點擊下方 "SAVE & RESTART" 即可連線。</div>)}
                                            <div className="bg-black/50 p-3 rounded border border-zinc-700 text-xs text-gray-400 mt-4"><strong className="text-gray-300 block mb-1">如何取得 Config:</strong><ol className="list-decimal pl-4 space-y-1"><li>進入 Firebase Console</li><li>點擊您的專案 -&gt; 左上角齒輪 -&gt; <strong>專案設定</strong></li><li>捲動到下方 <strong>您的應用程式</strong></li><li>選擇 <strong>Config</strong> 並複製值</li></ol></div>
                                        </div>
                                        <div className="space-y-4"><div><label className="text-xs text-gray-500 block mb-1">API Key</label><input className="w-full p-3 rounded bg-black border border-zinc-700 text-white font-mono-tech text-sm" value={fbConfig.apiKey} onChange={e => setFbConfig({ ...fbConfig, apiKey: e.target.value })} /></div><div className="grid grid-cols-2 gap-4"><div><label className="text-xs text-gray-500 block mb-1">Auth Domain</label><input className="w-full p-3 rounded bg-black border border-zinc-700 text-white font-mono-tech text-sm" value={fbConfig.authDomain} onChange={e => setFbConfig({ ...fbConfig, authDomain: e.target.value })} /></div><div><label className="text-xs text-gray-500 block mb-1">Project ID</label><input className="w-full p-3 rounded bg-black border border-zinc-700 text-white font-mono-tech text-sm" value={fbConfig.projectId} onChange={e => setFbConfig({ ...fbConfig, projectId: e.target.value })} /></div></div><div className="grid grid-cols-2 gap-4"><div><label className="text-xs text-gray-500 block mb-1">Storage Bucket</label><input className="w-full p-3 rounded bg-black border border-zinc-700 text-white font-mono-tech text-sm" value={fbConfig.storageBucket} onChange={e => setFbConfig({ ...fbConfig, storageBucket: e.target.value })} /></div><div><label className="text-xs text-gray-500 block mb-1">Messaging Sender ID</label><input className="w-full p-3 rounded bg-black border border-zinc-700 text-white font-mono-tech text-sm" value={fbConfig.messagingSenderId} onChange={e => setFbConfig({ ...fbConfig, messagingSenderId: e.target.value })} /></div></div><div><label className="text-xs text-gray-500 block mb-1">App ID</label><input className="w-full p-3 rounded bg-black border border-zinc-700 text-white font-mono-tech text-sm" value={fbConfig.appId} onChange={e => setFbConfig({ ...fbConfig, appId: e.target.value })} /></div></div><div className="mt-8 flex justify-between items-center border-t border-zinc-800 pt-4"><button onClick={() => setFbConfig({ apiKey: '', authDomain: '', projectId: '', storageBucket: '', messagingSenderId: '', appId: '' })} className="text-red-500 text-sm hover:underline">清除設定 Clear Config</button></div></div>
                                </div>
                            )}
                        </div>
                        <div className="p-6 border-t border-zinc-700 bg-black flex justify-end gap-4"><button onClick={onClose} className="px-6 py-2 text-gray-400 border border-zinc-700 rounded">CANCEL</button><button onClick={handleSaveAll} className="px-8 py-2 bg-white text-black rounded font-bold hover:scale-105 transition-transform">SAVE & RESTART</button></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [rmas, setRmas] = useState([]);
            const [currentRMA, setCurrentRMA] = useState(INITIAL_STATE);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterType, setFilterType] = useState('All');
            const [quickFilter, setQuickFilter] = useState('ALL');
            const [activeZone, setActiveZone] = useState('ALL');
            const [isDirty, setIsDirty] = useState(false);
            const [brandsConfig, setBrandsConfig] = useState(INITIAL_BRANDS);
            const [dealersConfig, setDealersConfig] = useState(INITIAL_DEALERS);
            const [accessoriesConfig, setAccessoriesConfig] = useState(INITIAL_ACCESSORIES);
            const [themeImages, setThemeImages] = useState(DEFAULT_THEME_IMAGES);
            const [db, setDb] = useState(null);
            const [isCloudMode, setIsCloudMode] = useState(false);
            const fileInputRef = useRef(null);
            const [shipModal, setShipModal] = useState({ open: false, rma: null, isBrand: false, courier: '', tracking: '' });
            const [deletingId, setDeletingId] = useState(null);
            const [dataModalOpen, setDataModalOpen] = useState(false);
            const [configModalOpen, setConfigModalOpen] = useState(false);
            const [confirmState, setConfirmState] = useState({ open: false, action: () => { } });

            useEffect(() => {
                const savedConfig = localStorage.getItem('mastex_brands_config');
                if (savedConfig) try { setBrandsConfig(JSON.parse(savedConfig)); } catch (e) { }
                const savedDealers = localStorage.getItem('mastex_dealers_config');
                if (savedDealers) try { setDealersConfig(JSON.parse(savedDealers)); } catch (e) { }
                const savedAccessories = localStorage.getItem('mastex_accessories_config');
                if (savedAccessories) try { setAccessoriesConfig(JSON.parse(savedAccessories)); } catch (e) { }
                const savedTheme = localStorage.getItem('mastex_theme_config');
                if (savedTheme) try { setThemeImages(JSON.parse(savedTheme)); } catch (e) { }

                let fbConfigStr = localStorage.getItem('mastex_firebase_config');
                // AUTO-CONNECT: If no local config, use PRESET
                if (!fbConfigStr && PRESET_FIREBASE_CONFIG && PRESET_FIREBASE_CONFIG.apiKey) {
                    console.log("No local config found. Using PRESET configuration.");
                    fbConfigStr = JSON.stringify(PRESET_FIREBASE_CONFIG);
                }

                if (fbConfigStr) {
                    try {
                        const fbConfig = JSON.parse(fbConfigStr);
                        if (fbConfig.apiKey && fbConfig.projectId) {
                            if (!firebase.apps.length) firebase.initializeApp(fbConfig);
                            const firestore = firebase.firestore();
                            setDb(firestore);
                            setIsCloudMode(true);
                            console.log("Firebase Initialized (Cloud Mode)");
                            return;
                        }
                    } catch (e) { console.error("Firebase Init Failed:", e); setIsCloudMode(false); }
                }
                setIsCloudMode(false);
                const savedRMAs = localStorage.getItem('mastex_rma_db_v4');
                if (savedRMAs) try { const parsed = JSON.parse(savedRMAs); if (Array.isArray(parsed)) setRmas(parsed); } catch (e) { }
            }, []);

            useEffect(() => {
                if (isCloudMode && db) {
                    const unsubscribeRmas = db.collection("rmas").onSnapshot((snapshot) => { const rmaData = []; snapshot.forEach((doc) => { rmaData.push(doc.data()); }); setRmas(rmaData); });
                    const unsubscribeTheme = db.collection("settings").doc("theme").onSnapshot((docSnap) => { if (docSnap.exists) { const newTheme = docSnap.data(); setThemeImages(newTheme); localStorage.setItem('mastex_theme_config', JSON.stringify(newTheme)); } });
                    return () => { unsubscribeRmas(); unsubscribeTheme(); };
                } else { if (!isCloudMode) localStorage.setItem('mastex_rma_db_v4', JSON.stringify(rmas)); }
            }, [rmas, isCloudMode, db]);

            useEffect(() => {
                const restoreState = () => {
                    const params = new URLSearchParams(window.location.search);
                    const v = params.get('v') || 'dashboard';
                    const z = params.get('z') || 'ALL';
                    const q = params.get('q') || 'ALL';
                    const f = params.get('f') || 'All';
                    setView(v); setActiveZone(z); setQuickFilter(q); setFilterType(f);
                    setIsDirty(false); setShipModal(prev => ({ ...prev, open: false })); setConfigModalOpen(false); setDataModalOpen(false); setConfirmState(prev => ({ ...prev, open: false }));
                };
                restoreState();
                window.addEventListener('popstate', restoreState);
                return () => window.removeEventListener('popstate', restoreState);
            }, []);

            const navigateTo = (newView, newZone, newQuick, newFilterType) => {
                setView(newView); setActiveZone(newZone); setQuickFilter(newQuick); setFilterType(newFilterType);
                const params = new URLSearchParams();
                if (newView !== 'dashboard') params.set('v', newView);
                if (newZone !== 'ALL') params.set('z', newZone);
                if (newQuick !== 'ALL') params.set('q', newQuick);
                if (newFilterType !== 'All') params.set('f', newFilterType);
                const newUrl = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
                window.history.pushState({}, '', newUrl);
            };

            const handleSaveConfig = async (newBrands, newDealers, newAccessories, newTheme) => {
                setBrandsConfig(newBrands); setDealersConfig(newDealers); setAccessoriesConfig(newAccessories); if (newTheme) setThemeImages(newTheme);
                localStorage.setItem('mastex_brands_config', JSON.stringify(newBrands)); localStorage.setItem('mastex_dealers_config', JSON.stringify(newDealers)); localStorage.setItem('mastex_accessories_config', JSON.stringify(newAccessories)); if (newTheme) localStorage.setItem('mastex_theme_config', JSON.stringify(newTheme));
                if (isCloudMode && db && newTheme) try { await db.collection("settings").doc("theme").set(newTheme); } catch (e) { console.error("Failed to sync theme to cloud", e); }
                setConfigModalOpen(false);
            };

            const handleSaveFirebase = (config) => { if (config) localStorage.setItem('mastex_firebase_config', JSON.stringify(config)); else localStorage.removeItem('mastex_firebase_config'); window.location.reload(); };
            const withConfirmation = (action, message) => { if (view === 'form' && isDirty) setConfirmState({ open: true, action, message: message || "您有尚未儲存的變更，離開將導致資料遺失。\n確定要離開嗎？" }); else action(); };
            
            const handleBack = (force = false) => {
                const performBack = () => {
                    setIsDirty(false);
                    if (force) { window.history.back(); return; }
                    if (view === 'form' || view === 'print') { if (activeZone !== 'ALL') navigateTo('list', activeZone, quickFilter, filterType); else navigateTo('dashboard', 'ALL', 'ALL', 'All'); }
                    else if (view === 'list') navigateTo('dashboard', 'ALL', 'ALL', 'All');
                };
                if (force) performBack(); else withConfirmation(performBack);
            };

            const handleCreate = () => { withConfirmation(() => { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); const id = Date.now().toString() + Math.random().toString(36).substr(2, 5); const rmaNo = `TW-${now.toISOString().slice(0, 10).replace(/-/g, '')}-${Math.floor(Math.random() * 100).toString().padStart(2, '0')}`; setCurrentRMA({ ...INITIAL_STATE, id, rmaNumber: rmaNo, creationDate: now.toISOString().slice(0, 16) }); setIsDirty(false); navigateTo('form', 'CS', quickFilter, filterType); }, "您有未儲存的變更，確定要放棄目前編輯並建立新工單嗎？"); };
            
            const saveToDb = async (rma) => { if (isCloudMode && db) try { await db.collection("rmas").doc(rma.id).set(rma); } catch (e) { alert("Cloud Save Failed: " + e); } else setRmas(prev => { const idx = prev.findIndex(r => r.id === rma.id); return idx >= 0 ? prev.map((r, i) => i === idx ? rma : r) : [rma, ...prev]; }); };
            const deleteFromDb = async (id) => { if (isCloudMode && db) await db.collection("rmas").doc(id).delete(); else setRmas(prev => prev.filter(r => r.id !== id)); };
            
            const handleSave = () => {
                let errorMessage = '';
                if (currentRMA.customerType === 'C' && !currentRMA.customerName.trim()) errorMessage = '請填寫 消費者姓名 (Name)';
                else if (currentRMA.customerType === 'B' && !currentRMA.dealerName.trim()) errorMessage = '請填寫 經銷商名稱 (Dealer Name)';

                if (errorMessage) {
                    setConfirmState({ open: true, isAlert: true, title: "資料不完整 MISSING DATA", message: errorMessage, confirmText: "了解 OK", action: () => {} });
                    return;
                }

                saveToDb(currentRMA);
                setIsDirty(false);
                if (activeZone !== 'ALL') navigateTo('list', activeZone, quickFilter, filterType);
                else navigateTo('dashboard', 'ALL', 'ALL', 'All');
            };

            const cancelDelete = () => setDeletingId(null);

            const handleUpdate = (f, v) => { setCurrentRMA(p => ({ ...p, [f]: v })); setIsDirty(true); };
            
            const openShip = (rma, isBrand) => { setShipModal({ open: true, rma, isBrand, courier: isBrand ? '順豐速運 (SF)' : '新竹物流 (HCT)', tracking: '' }); };
            const confirmShip = (courier, tracking) => {
                if (!shipModal.rma) return;
                const today = new Date().toISOString().split('T')[0];
                let newStatus = shipModal.rma.status;
                let newDefectiveLoc = shipModal.rma.defectiveLoc;
                const isSwapFlow = shipModal.rma.csAction === 'direct_swap' || ['swap_new'].includes(shipModal.rma.resolution);
                if (shipModal.isBrand) { newDefectiveLoc = 'shipped_brand'; if (!isSwapFlow) newStatus = '已寄原廠'; } 
                else { if (isSwapFlow || newStatus === '新品待寄出') newStatus = '新品已寄出'; else newStatus = '已寄回'; }
                const updated = { ...shipModal.rma, status: newStatus, defectiveLoc: newDefectiveLoc, returnDate: today, courier: courier, trackingNumber: tracking };
                saveToDb(updated); setShipModal({ ...shipModal, open: false });
            };

            const handleConfirmReceive = (rma) => {
                const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                const receivedTime = now.toISOString().slice(0, 16);
                let updatedRMA = { ...rma, isReceived: true, receivedDate: receivedTime };
                const isSwapFlow = rma.csAction === 'direct_swap' || rma.resolution === 'swap_new';
                const isShippedState = ['新品已寄出', '已寄回', '已寄原廠', '修復入庫', '新品待寄出'].includes(rma.status);
                if (!isSwapFlow && !isShippedState) { updatedRMA.status = '檢測中'; if (!updatedRMA.csAction) updatedRMA.csAction = 'standard_rma'; }
                saveToDb(updatedRMA); setCurrentRMA(updatedRMA); navigateTo('form', 'CS', quickFilter, filterType);
            };

            const handleEditRMA = (rma) => { withConfirmation(() => { setCurrentRMA(rma); setIsDirty(false); navigateTo('form', activeZone, quickFilter, filterType); }, "您有未儲存的變更，確定要放棄目前編輯並開啟此工單嗎？"); };
            const handleCardClick = (filterId, type = 'All', zone = 'ALL') => { withConfirmation(() => { setIsDirty(false); navigateTo('list', zone, filterId, type); }); };
            
            const handleExportData = () => { const dataStr = JSON.stringify(rmas, null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.download = `mastex_rma_backup_${new Date().toISOString().split('T')[0]}.json`; link.href = url; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const handleImportData = (e) => {
                const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const importedData = JSON.parse(event.target.result); if (Array.isArray(importedData)) { setConfirmState({ open: true, title: "確認匯入 IMPORT DATA", message: `確定要匯入 ${importedData.length} 筆資料嗎？\n${isCloudMode ? '這將會寫入雲端資料庫 (Cloud DB)。' : '現有本機資料將被覆蓋。'}`, confirmText: "匯入 IMPORT", action: async () => { if (isCloudMode && db) { alert("開始上傳至雲端... 請稍候"); let count = 0; for (const r of importedData) { await db.collection("rmas").doc(r.id).set(r); count++; } alert(`成功上傳 ${count} 筆資料至雲端`); } else { setRmas(importedData); } setDataModalOpen(false); } }); } } catch (err) { alert('檔案錯誤'); } }; reader.readAsText(file);
            };

            const filteredRmas = rmas.filter(r => {
                const s = searchTerm.toLowerCase();
                const matchText = (r.rmaNumber || '').toLowerCase().includes(s) || (r.customerName || '').toLowerCase().includes(s) || (r.dealerName || '').toLowerCase().includes(s) || (r.serialNumber || '').toLowerCase().includes(s) || (r.refNumber || '').toLowerCase().includes(s) || (r.trackingNumber || '').toLowerCase().includes(s) || (r.endUserName || '').toLowerCase().includes(s);
                let matchQuick = true;
                if (quickFilter === 'URGENT_REPAIR') { matchQuick = r.customerType === 'C' && r.csAction === 'standard_rma' && ['待收件', '檢測中', '待料中', 'Pending', 'Checking', 'Waiting Parts'].includes(r.status); }
                else if (quickFilter === 'PENDING_REPAIR') { const isDealerRepair = r.customerType === 'B' && r.csAction === 'standard_rma' && ['待收件', '檢測中', '待料中', 'Pending', 'Checking', 'Waiting Parts'].includes(r.status); const isSwapOldUnit = (r.csAction === 'direct_swap' || ['swap_new'].includes(r.resolution)) && r.isReceived && !r.defectiveLoc; matchQuick = isDealerRepair || isSwapOldUnit; }
                else if (quickFilter === 'NEW_PENDING') { matchQuick = ['新品待寄出', '完修待寄回', 'Pending Ship', 'Repaired'].includes(r.status); }
                else if (quickFilter === 'TECH_HISTORY') { matchQuick = ['已寄回', '已寄原廠', '修復入庫', '新品已寄出', 'Returned', 'Shipped to Brand', 'Restocked', 'Shipped', 'To Brand'].includes(r.status); }
                else if (quickFilter === 'SALES_WRAP') { matchQuick = ['待料中', 'Waiting Parts'].includes(r.status) || r.defectiveLoc === 'waiting_parts'; }
                else if (quickFilter === 'SALES_BRAND_RMA') { matchQuick = ['待寄原廠', 'To Brand'].includes(r.status) || r.defectiveLoc === 'brand_rma'; }
                else if (quickFilter === 'SALES_ALL') { const inventoryStatuses = ['待料中', '待寄原廠', '修復入庫', '已寄原廠', 'Waiting Parts', 'To Brand', 'Restocked', 'Shipped to Brand']; const inventoryLocs = ['warehouse', 'waiting_parts', 'brand_rma', 'shipped_brand', 'display']; matchQuick = inventoryStatuses.includes(r.status) || inventoryLocs.includes(r.defectiveLoc); }
                else if (quickFilter === 'CS_ALL') { matchQuick = true; } else if (quickFilter === 'CS_B2B') { matchQuick = r.customerType === 'B'; } else if (quickFilter === 'CS_B2C') { matchQuick = r.customerType === 'C'; }
                const matchType = (filterType === 'All' || quickFilter.includes('CS_')) || r.customerType === filterType;
                return matchText && matchQuick && matchType;
            }).sort((a, b) => (a.refNumber || '').localeCompare(b.refNumber || ''));

            const stats = {
                urgentRepair: rmas.filter(r => r.customerType === 'C' && r.csAction === 'standard_rma' && ['待收件', '檢測中', '待料中', 'Pending', 'Checking', 'Waiting Parts'].includes(r.status)).length,
                pendingRepair: rmas.filter(r => (r.customerType === 'B' && r.csAction === 'standard_rma' && ['待收件', '檢測中', '待料中', 'Pending', 'Checking', 'Waiting Parts'].includes(r.status)) || ((r.csAction === 'direct_swap' || ['swap_new'].includes(r.resolution)) && r.isReceived && !r.defectiveLoc)).length,
                newPending: rmas.filter(r => ['新品待寄出', '完修待寄回', 'Pending Ship', 'Repaired'].includes(r.status)).length,
                shipped: rmas.filter(r => ['已寄回', '已寄原廠', '修復入庫', '新品已寄出', 'Returned', 'Shipped to Brand', 'Restocked', 'Shipped'].includes(r.status)).length
            };
            const inventoryCount = rmas.filter(r => ['待料中', '待寄原廠', '修復入庫', '已寄原廠', 'Waiting Parts', 'To Brand', 'Restocked', 'Shipped to Brand'].includes(r.status) || ['warehouse', 'waiting_parts', 'brand_rma', 'shipped_brand', 'display'].includes(r.defectiveLoc)).length;

            const dataProps = { dealers: dealersConfig, brands: brandsConfig, sources: INITIAL_SOURCES, couriers: INITIAL_COURIERS, accessories: accessoriesConfig, conditions: CONDITIONS };

            return (
                <div className="flex flex-col min-h-screen w-full relative bg-[#050505] overflow-x-hidden">
                    <ConfirmModal isOpen={confirmState.open} onClose={() => setConfirmState({ ...confirmState, open: false })} onConfirm={confirmState.action} message={confirmState.message} />
                    
                    {view !== 'print' && (
                        <header className="h-20 border-b border-zinc-800 bg-black/90 backdrop-blur flex items-center px-6 md:px-8 justify-between sticky top-0 z-50 print-hidden shrink-0">
                            <div className="flex items-center gap-6">
                                <div className="flex items-center cursor-pointer gap-5" onClick={() => handleBack()}>
                                    <Logo />
                                    <div className="flex flex-col justify-center">
                                        <h1 className="text-2xl font-black tracking-widest text-white leading-none">MASTEX <span className="text-lg text-gray-500 font-normal">三鍵客</span></h1>
                                        <div className="flex items-center gap-2 mt-1">
                                            <p className="text-xs text-gray-400 font-mono-tech tracking-[0.2em]">RMA SYSTEM <span className="text-teal-500 font-bold">v122.19 (Final Fixed)</span></p>
                                            <div className={`flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-bold border ${isCloudMode ? 'bg-green-900/30 border-green-500 text-green-400' : 'bg-zinc-800 border-zinc-600 text-gray-400'}`}>
                                                <Icon name={isCloudMode ? "Wifi" : "WifiOff"} size={12} />
                                                {isCloudMode ? 'CLOUD ONLINE' : 'LOCAL MODE'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="hidden md:flex h-10 w-px bg-zinc-800 mx-2"></div>
                                <button onClick={handleCreate} className="hidden md:flex bg-blue-600 hover:bg-blue-500 text-white px-5 py-2.5 rounded-lg font-bold text-sm items-center gap-2 shadow-lg shadow-blue-900/20 transition-all border border-blue-500 hover:scale-105"><Icon name="Plus" size={18}/> 建立工單 NEW TICKET</button>
                            </div>
                            <div className="flex items-center gap-6">
                                <button onClick={() => setConfigModalOpen(true)} className="flex items-center gap-2 px-3 py-2 bg-zinc-800/50 hover:bg-zinc-800 border border-zinc-700 rounded-lg text-gray-300 font-bold transition-colors"><Icon name="Settings" size={18}/></button>
                                <button onClick={() => setDataModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-zinc-800/50 hover:bg-zinc-800 border border-zinc-700 rounded-lg text-gray-300 font-bold text-xs transition-colors"><Icon name="Database" size={16}/> <span className="hidden md:inline">資料管理 DATA</span></button>
                            </div>
                        </header>
                    )}

                    <main className="flex-1 w-full print:bg-white flex flex-col">
                        {view === 'dashboard' && (
                            <div key={JSON.stringify(themeImages)} className="flex-1 w-full px-4 md:px-6 py-6 animate-fade-in overflow-y-auto">
                                <div className="grid grid-cols-1 xl:grid-cols-12 gap-6 min-h-[calc(100vh-14rem)]">
                                    <div className="xl:col-span-3 flex flex-col">
                                        <div onClick={() => handleCardClick('CS_ALL', 'All', 'CS')} className="group relative h-full min-h-[400px] w-full overflow-hidden rounded-3xl bg-zinc-900 border border-zinc-800 transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_-15px_rgba(0,0,0,0.7)] hover:ring-2 hover:ring-blue-500 cursor-pointer">
                                            <div className="absolute inset-0 bg-cover bg-center transition-transform duration-1000 ease-out group-hover:scale-110" style={{ backgroundImage: `url(${themeImages.CS})` }} />
                                            <div className="absolute inset-0 bg-gradient-to-t from-black/95 via-blue-950/30 to-transparent" />
                                            <div className="relative z-10 flex h-full flex-col p-8">
                                                <div className="flex items-center justify-between mb-4"><div className="flex h-12 w-12 items-center justify-center rounded-full bg-blue-500/20 text-blue-400 backdrop-blur-md border border-blue-500/30"><Icon name="User" size={24} /></div><button onClick={(e) => { e.stopPropagation(); handleCreate(); }} className="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-full shadow-lg border border-blue-400/50 md:hidden"><Icon name="Plus" size={24}/></button></div>
                                                <div className="mt-auto"><h3 className="text-sm font-bold tracking-[0.2em] text-blue-300 uppercase mb-2">客服中心</h3><div className="flex items-baseline gap-3"><span className="font-mono-tech text-7xl font-bold text-white tracking-tighter drop-shadow-2xl">{rmas.length}</span><span className="text-base font-bold text-gray-400">件</span></div><p className="text-xs text-blue-200/70 mt-2 font-mono-tech">目前案件總數</p></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="xl:col-span-6 grid grid-rows-2 gap-6">
                                        <div className="grid grid-cols-2 gap-6 h-full min-h-[280px]">
                                            <div onClick={() => handleCardClick('URGENT_REPAIR', 'All', 'TECH')} className="group relative h-full w-full overflow-hidden rounded-3xl bg-zinc-900 border border-zinc-800 transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_-15px_rgba(220,38,38,0.3)] hover:ring-2 hover:ring-red-500 cursor-pointer">
                                                <div className="absolute inset-0 bg-cover bg-center transition-transform duration-1000 ease-out group-hover:scale-110" style={{ backgroundImage: `url(${themeImages.URGENT})` }} />
                                                <div className="absolute inset-0 bg-gradient-to-t from-black/95 via-red-950/30 to-transparent" />
                                                <div className="relative z-10 flex h-full flex-col justify-between p-6">
                                                    <div className="flex h-10 w-10 items-center justify-center rounded-full bg-red-500/20 text-red-400 backdrop-blur-md border border-red-500/30"><Icon name="AlertTriangle" size={20} /></div>
                                                    <div><div className="text-5xl font-bold font-mono-tech text-white mb-1">{stats.urgentRepair}</div><div className="text-sm font-bold text-red-300 tracking-wider uppercase">急件待修</div></div>
                                                </div>
                                            </div>
                                            <div onClick={() => handleCardClick('PENDING_REPAIR', 'All', 'TECH')} className="group relative h-full w-full overflow-hidden rounded-3xl bg-zinc-900 border border-zinc-800 transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_-15px_rgba(113,113,122,0.3)] hover:ring-2 hover:ring-gray-400 cursor-pointer">
                                                <div className="absolute inset-0 bg-cover bg-center transition-transform duration-1000 ease-out group-hover:scale-110" style={{ backgroundImage: `url(${themeImages.PENDING})` }} />
                                                <div className="absolute inset-0 bg-gradient-to-t from-black/95 via-zinc-950/30 to-transparent" />
                                                <div className="relative z-10 flex h-full flex-col justify-between p-6">
                                                    <div className="flex h-10 w-10 items-center justify-center rounded-full bg-gray-500/20 text-gray-300 backdrop-blur-md border border-gray-500/30"><Icon name="Cpu" size={20} /></div>
                                                    <div><div className="text-5xl font-bold font-mono-tech text-white mb-1">{stats.pendingRepair}</div><div className="text-sm font-bold text-gray-300 tracking-wider uppercase">一般待修</div></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-6 h-full min-h-[280px]">
                                            <div onClick={() => handleCardClick('NEW_PENDING', 'All', 'TECH')} className="group relative h-full w-full overflow-hidden rounded-3xl bg-zinc-900 border border-zinc-800 transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_-15px_rgba(234,179,8,0.3)] hover:ring-2 hover:ring-yellow-500 cursor-pointer">
                                                <div className="absolute inset-0 bg-cover bg-center transition-transform duration-1000 ease-out group-hover:scale-110" style={{ backgroundImage: `url(${themeImages.SHIPPING})` }} />
                                                <div className="absolute inset-0 bg-gradient-to-t from-black/95 via-yellow-950/30 to-transparent" />
                                                <div className="relative z-10 flex h-full flex-col justify-between p-6">
                                                    <div className="flex h-10 w-10 items-center justify-center rounded-full bg-yellow-500/20 text-yellow-400 backdrop-blur-md border border-yellow-500/30"><Icon name="Package" size={20} /></div>
                                                    <div><div className="text-5xl font-bold font-mono-tech text-white mb-1">{stats.newPending}</div><div className="text-sm font-bold text-yellow-300 tracking-wider uppercase">產品待寄</div></div>
                                                </div>
                                            </div>
                                            <div onClick={() => handleCardClick('TECH_HISTORY', 'All', 'TECH')} className="group relative h-full w-full overflow-hidden rounded-3xl bg-zinc-900 border border-zinc-800 transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_-15px_rgba(22,163,74,0.3)] hover:ring-2 hover:ring-green-500 cursor-pointer">
                                                <div className="absolute inset-0 bg-cover bg-center transition-transform duration-1000 ease-out group-hover:scale-110" style={{ backgroundImage: `url(${themeImages.HISTORY})` }} />
                                                <div className="absolute inset-0 bg-gradient-to-t from-black/95 via-green-950/30 to-transparent" />
                                                <div className="relative z-10 flex h-full flex-col justify-between p-6">
                                                    <div className="flex h-10 w-10 items-center justify-center rounded-full bg-green-500/20 text-green-400 backdrop-blur-md border border-green-500/30"><Icon name="CheckCircle" size={20} /></div>
                                                    <div><div className="text-5xl font-bold font-mono-tech text-white mb-1">{stats.shipped}</div><div className="text-sm font-bold text-green-300 tracking-wider uppercase">已出貨</div></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="xl:col-span-3 flex flex-col">
                                        <div onClick={() => handleCardClick('SALES_ALL', 'All', 'SALES')} className="group relative h-full min-h-[400px] w-full overflow-hidden rounded-3xl bg-zinc-900 border border-zinc-800 transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_-15px_rgba(249,115,22,0.3)] hover:ring-2 hover:ring-orange-500 cursor-pointer">
                                            <div className="absolute inset-0 bg-cover bg-center transition-transform duration-1000 ease-out group-hover:scale-110" style={{ backgroundImage: `url(${themeImages.INVENTORY})` }} />
                                            <div className="absolute inset-0 bg-gradient-to-t from-black/95 via-orange-950/30 to-transparent" />
                                            <div className="relative z-10 flex h-full flex-col p-8">
                                                <div className="flex h-12 w-12 items-center justify-center rounded-full bg-orange-500/20 text-orange-400 backdrop-blur-md border border-orange-500/30 mb-auto"><Icon name="Briefcase" size={24} /></div>
                                                <div className="mt-auto"><h3 className="text-sm font-bold tracking-[0.2em] text-orange-300 uppercase mb-2">舊品庫存</h3><div className="flex items-baseline gap-3"><span className="font-mono-tech text-7xl font-bold text-white tracking-tighter drop-shadow-2xl">{inventoryCount}</span><span className="text-base font-bold text-gray-400">件</span></div><p className="text-xs text-orange-200/70 mt-2 font-mono-tech">庫存與借用</p></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {view === 'list' && (
                            <div className="w-full px-6 md:px-8 py-8 animate-fade-in flex-1">
                                <div className="mb-6 flex items-center gap-4"><button onClick={() => handleBack()} className="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded border border-zinc-600 text-gray-300 font-bold flex items-center gap-2 text-sm"><Icon name="ArrowLeft" size={16} /> 返回儀表板 DASHBOARD</button><h2 className="text-xl font-bold text-white flex items-center gap-2">工單清單 <span className="text-xs font-mono-tech text-gray-500 bg-zinc-900 px-2 py-1 rounded border border-zinc-800">{quickFilter}</span></h2></div>
                                {activeZone === 'SALES' && (<div className="mb-6 flex gap-4"><button onClick={() => setQuickFilter('SALES_ALL')} className={`px-4 py-2 rounded font-bold text-sm ${quickFilter === 'SALES_ALL' ? 'bg-orange-500 text-white' : 'bg-zinc-800 text-gray-400'}`}>全部 ALL</button><button onClick={() => setQuickFilter('SALES_WRAP')} className={`px-4 py-2 rounded font-bold text-sm ${quickFilter === 'SALES_WRAP' ? 'bg-orange-500 text-white' : 'bg-zinc-800 text-gray-400'}`}>待料</button><button onClick={() => setQuickFilter('SALES_BRAND_RMA')} className={`px-4 py-2 rounded font-bold text-sm ${quickFilter === 'SALES_BRAND_RMA' ? 'bg-orange-500 text-white' : 'bg-zinc-800 text-gray-400'}`}>待寄原廠</button></div>)}
                                {activeZone === 'CS' && (<div className="mb-6 flex gap-4"><button onClick={() => { setQuickFilter('CS_ALL'); setFilterType('All'); }} className={`px-4 py-2 rounded font-bold text-sm ${quickFilter === 'CS_ALL' ? 'bg-blue-600 text-white' : 'bg-zinc-800 text-gray-400'}`}>全部 ALL</button><button onClick={() => { setQuickFilter('CS_B2C'); setFilterType('C'); }} className={`px-4 py-2 rounded font-bold text-sm ${quickFilter === 'CS_B2C' ? 'bg-blue-600 text-white' : 'bg-zinc-800 text-gray-400'}`}>消費者 B2C</button><button onClick={() => { setQuickFilter('CS_B2B'); setFilterType('B'); }} className={`px-4 py-2 rounded font-bold text-sm ${quickFilter === 'CS_B2B' ? 'bg-blue-600 text-white' : 'bg-zinc-800 text-gray-400'}`}>經銷商 B2B</button></div>)}
                                {activeZone === 'TECH' && quickFilter === 'PENDING_REPAIR' && (<div className="mb-6 flex gap-4"><button onClick={() => setFilterType('All')} className={`px-4 py-2 rounded font-bold text-sm ${filterType === 'All' ? 'bg-zinc-600 text-white' : 'bg-zinc-800 text-gray-400'}`}>全部 ALL</button><button onClick={() => setFilterType('C')} className={`px-4 py-2 rounded font-bold text-sm ${filterType === 'C' ? 'bg-zinc-600 text-white' : 'bg-zinc-800 text-gray-400'}`}>消費者 B2C (Swap)</button><button onClick={() => setFilterType('B')} className={`px-4 py-2 rounded font-bold text-sm ${filterType === 'B' ? 'bg-zinc-600 text-white' : 'bg-zinc-800 text-gray-400'}`}>經銷商 B2B</button></div>)}
                                <div className="search-zone-bg p-6 rounded-xl flex flex-col md:flex-row justify-between gap-6 shadow-2xl mb-8 border border-zinc-800"><div className="flex flex-1 gap-4 items-center"><h3 className="text-sm font-bold text-gray-400">工單檢索</h3><input type="text" placeholder="搜尋..." className="flex-1 bg-black border border-zinc-600 py-2 px-4 rounded text-white" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div></div>
                                <div className="tech-card rounded-xl overflow-hidden border border-zinc-800">
                                    <table className="w-full text-left text-base text-gray-300">
                                        <thead className="bg-zinc-900/80 text-gray-500 font-bold border-b border-zinc-800 text-xs uppercase"><tr><th className="p-5">{activeZone === 'SALES' ? '庫存狀態 STATUS' : '狀態 STATUS'}</th><th className="p-5 w-20">類型 TYPE</th><th className="p-5">單號 ID</th><th className="p-5">客戶 CLIENT</th><th className="p-5">產品 DEVICE</th><th className="p-5 text-right">操作 ACTION</th></tr></thead>
                                        <tbody className="divide-y divide-zinc-800/50">
                                            {filteredRmas.map(r => (<SwipeableRow key={r.id} onClick={() => handleEditRMA(r)} onDelete={() => requestDelete(r.id)} isDeleting={deletingId === r.id} onConfirm={() => confirmDelete(r.id)} onCancel={cancelDelete} className="rma-row hover:bg-zinc-900">
                                                <td className="p-5">{activeZone === 'SALES' ? (<div className="flex flex-col items-start gap-1.5">{(r.defectiveLoc || DEFECTIVE_LOC_LABELS[r.status]) ? (<span className={`text-xs px-2 py-1 border rounded font-bold ${DEFECTIVE_LOC_STYLES[r.defectiveLoc] || STATUS_STYLES[r.status] || 'text-gray-400 border-gray-600'}`}>{DEFECTIVE_LOC_LABELS[r.defectiveLoc] || r.status}</span>) : (<span className={`text-xs px-2 py-1 border rounded font-bold ${STATUS_STYLES[r.status]}`}>{r.status}</span>)}{r.isBorrowed && (<div className="flex flex-col"><span className="text-[10px] font-bold text-red-400 border border-red-900 bg-red-900/20 px-1.5 py-0.5 rounded w-fit mb-0.5">外借中 BORROWED</span>{(() => { const lastLog = r.displayLog ? [...r.displayLog].reverse().find(l => l.action.includes('借出')) : null; if (lastLog) return (<span className="text-[10px] text-gray-400 font-mono-tech"><span className="text-white font-bold">{lastLog.name}</span> <span className="text-gray-600">|</span> {lastLog.date}</span>); return null; })()}</div>)}</div>) : (<div className="flex flex-col gap-1 items-start"><span className={`text-xs px-2 py-1 border rounded font-bold ${STATUS_STYLES[r.status]}`}>{r.status}</span>{r.returnTarget && (['新品待寄出', '新品已寄出', '已寄回', '完修待寄回', '修復入庫', 'Pending Ship', 'Shipped', 'Returned', 'Repaired', 'Restocked'].includes(r.status)) && (<span className={`text-[10px] px-1.5 py-0.5 border rounded font-bold ${r.returnTarget === 'store' ? 'text-purple-400 border-purple-500' : 'text-blue-400 border-blue-500'}`}>{r.returnTarget === 'store' ? 'TO STORE' : 'TO CUST'}</span>)}</div>)}</td>
                                                <td className="p-5"><span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border ${r.customerType === 'B' ? 'border-blue-500 text-blue-400' : 'border-purple-500 text-purple-400'}`}>{r.customerType === 'B' ? 'B2B' : 'B2C'}</span></td><td className="p-5 text-white">{r.refNumber && <div className="font-mono-tech text-yellow-500 text-lg font-bold mb-1">{r.refNumber}</div>}<div className="font-mono-tech text-gray-400 text-sm">{r.rmaNumber}</div></td><td className="p-5 text-white"><div className="font-bold">{r.customerType === 'B' ? r.dealerName : r.customerName}</div>{r.customerType === 'B' && <div className="mt-1"><span className="text-xs text-gray-500">終端客戶:</span> <span className="text-sm font-bold text-gray-300">{r.endUserName}</span></div>}</td><td className="p-5">{r.brand} {r.model}</td><td className="p-5 text-right flex justify-end gap-2" onClick={e => e.stopPropagation()}>{!r.isReceived && (activeZone === 'ALL' || activeZone === 'CS') && (<button onClick={(e) => { e.stopPropagation(); handleConfirmReceive(r); }} className="px-3 py-1.5 border border-zinc-700 bg-zinc-800 rounded text-xs text-white hover:bg-zinc-700 font-bold">舊品簽收</button>)}{activeZone !== 'CS' && activeZone !== 'SALES' && (r.status === '完修待寄回' || r.status === '新品待寄出' || r.status === 'Repaired' || r.status === 'Pending Ship') && <button onClick={() => openShip(r, false)} className="px-3 py-1.5 rounded text-xs font-bold bg-blue-900 text-blue-100">出貨</button>}{activeZone !== 'CS' && activeZone !== 'SALES' && (r.status === '待寄原廠' || r.status === 'To Brand') && <button onClick={() => openShip(r, true)} className="px-3 py-1.5 bg-red-900 text-red-100 rounded text-xs">寄出</button>}<button onClick={() => { setCurrentRMA(r); navigateTo('print', activeZone, quickFilter, filterType); }} className="p-1.5 text-gray-400 hover:text-white"><Icon name="Printer" size={16} /></button><button onClick={(e) => { e.stopPropagation(); if (deletingId === r.id) cancelDelete(); else requestDelete(r.id); }} className="p-1.5 text-red-900 hover:text-red-500"><Icon name="Trash2" size={16} /></button></td>
                                            </SwipeableRow>))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        {view === 'form' && <FormView rma={currentRMA} onChange={handleUpdate} onSave={handleSave} onBack={handleBack} data={dataProps} activeZone={activeZone} openShip={openShip} onPrint={() => { setIsDirty(false); navigateTo('print', activeZone, quickFilter, filterType); }} />}
                        {view === 'print' && <PrintView rma={currentRMA} onBack={() => setView('list')} />}
                    </main>
                    {shipModal.open && <ShippingModal isOpen={shipModal.open} onClose={() => setShipModal({ ...shipModal, open: false })} onConfirm={confirmShip} title="出貨" defaultCourier={shipModal.courier} couriers={INITIAL_COURIERS} courierMgr={null} rma={shipModal.rma} />}
                    <ConfigModal isOpen={configModalOpen} onClose={() => setConfigModalOpen(false)} currentBrands={brandsConfig} currentDealers={dealersConfig} currentAccessories={accessoriesConfig} currentTheme={themeImages} onSave={handleSaveConfig} onSaveFirebase={handleSaveFirebase} />
                    {dataModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                            <div className="bg-zinc-900 border border-zinc-700 rounded-xl w-full max-w-lg p-8 shadow-2xl relative animate-fade-in">
                                <button onClick={() => setDataModalOpen(false)} className="absolute top-4 right-4 text-gray-500 hover:text-white"><Icon name="X" size={24}/></button>
                                <h3 className="text-xl font-bold text-white mb-6">資料管理 DATA MANAGEMENT</h3>
                                <div className="space-y-4">
                                    <button onClick={handleExportData} className="w-full py-4 bg-zinc-800 rounded text-white font-bold">匯出資料 EXPORT</button>
                                    <div className="relative"><button onClick={() => fileInputRef.current?.click()} className="w-full py-4 bg-zinc-800 rounded text-white font-bold">匯入資料 IMPORT</button><input type="file" ref={fileInputRef} onChange={handleImportData} className="hidden" accept=".json" /></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    })();
    </script>
</body>
</html>
